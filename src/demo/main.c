#include "stm8l10x.h"
  
//78.00.20.80+XX.40+YY  - (20) инверси€ изображени€	
//78.00.30.80+XX.40+YY  - (20) нормальное изображение

#define T191_Addr 			0x78	//LCD ADDR

#define GPIO_PULL_UP()		GPIOA->DDR=0; GPIOA->CR1=0xff; GPIOA->CR2=0;GPIOB->DDR=0; GPIOB->CR1=0xff; GPIOB->CR2=0;GPIOC->DDR=0; GPIOC->CR1=0xff; GPIOC->CR2=0;GPIOD->DDR=0; GPIOD->CR1=0xff; GPIOD->CR2=0;

#define ENC_INT()  	GPIOB->DDR &=(~0b111);GPIOB->CR1 |=0b111; GPIOB->CR2 |=0b111;
#define ENC()  			GPIOB->DDR &=(~0b111);GPIOB->CR1 |=0b111; GPIOB->CR2 &=(~0b111);

#define LCD_PORT()	 GPIOC->DDR |=0b111;GPIOC->CR1 &=(~0b11) | 1<<2;GPIOC->CR2 |=0b111;//SCL, SDA -OD,Reset Pin -PP
#define RES_LO()		(GPIOC->ODR &=(~1<<2))
#define RES_HI()		(GPIOC->ODR |=1<<2)

#define BUTTON() 	(GPIOB->IDR & 1<<1)
#define MENU()			(GPIOB->IDR & 1<<3)

uint16_t TimingDelay,sec_tic;
volatile bool  go_sleep=0,count_dir=1;
float temp_count,imp_per_metr;
volatile uint16_t Counter,slp=30000;
uint8_t button_sec=0; 

void TimingDelayDec(void) 															{//Delay Main function
 if (TimingDelay!=0x00) {TimingDelay--;}
 if (!sec_tic) {
				sec_tic=1000;
				if (!BUTTON()) button_sec++;
				else button_sec=0;
				} 
 if (!slp) {slp=30000;go_sleep=1;}
 sec_tic--;slp--;
 }
void delay_ms (uint16_t DelTime) 												{
    TimingDelay=DelTime;
  while(TimingDelay!= 0x00);
}
void init_encoder(void)																	{// Encoder INIT
CLK->PCKENR |= CLK_PCKENR_TIM2;
ENC();	// Encoder Pins Init

TIM2->SMCR 	|=0b011;  														 //Count both pins Ch1, Ch2
TIM2->CCER1 &=~(TIM_CCER1_CC1P | TIM_CCER1_CC2P); //пол€рность сигнала  - по спаду "0"
TIM2->CCER1 |= TIM_CCER1_CC1E | TIM_CCER1_CC2E;   //Enable
TIM2->CCMR1	|=0b01 | 0b1111<<4; //Filter On
TIM2->CCMR2 |=0b01 | 0b1111<<4; //Filter On

TIM2->CR1 |= TIM_CR1_CMS; 																 //CMS = 11 UP and Down

TIM2->ARRH = 0;TIM2->ARRL = 4;

TIM2->CNTRH=0;TIM2->CNTRL=0;											 // —брос счетчика
TIM2->CR1 |= TIM_CR1_ARPE;
//TIM2->CR1	&=~(TIM_CR1_ARPE);											//Preload - OFF
TIM2->IER	|= TIM_IER_UIE; 												//прерывание включено
TIM2->CR1 |= TIM_CR1_CEN; 												// запустить таймер

Counter = 0;

}
void initial(void)																			{//TIM4 INIT
CLK->CKDIVR = 2; 																	//16MHz / 2^2 = 4 MHz
//----------TIM4------------------
CLK->PCKENR |= CLK_PCKENR_TIM4;
TIM4->PSCR = 5;
TIM4->ARR = 124; 																	// 2^4 = 16, 16*125 = 2000 
TIM4->SR1 &=~TIM4_SR1_UIF; 												//сброс флага прерывани€ TIM4_ClearFlag(TIM4_FLAG_UPDATE); 	
TIM4->IER	|= TIM4_IER_UIE; 												//прерывание включено
TIM4->CR1 |= TIM4_CR1_CEN; 												// запустить таймер
_asm("rim");

GPIO_PULL_UP();
}
void i2c_init(void)																			{//I2C INIT
		CLK->PCKENR |= CLK_PCKENR_I2C;
		LCD_PORT();
		//-------I2C ENABLE----------------
		I2C->FREQR = 1;  							//2MHz
		I2C->CCRH=0x01; //0x0A
		I2C->CCRL=0x01; //I2C->CCRL=0x0B;
		I2C->CR1 |= I2C_CR1_PE;
}
//------------------------------------T191 LCD ------------------------------

const unsigned char T191_font[]= 												{// Font 8*5 
		 0x00, 0x00, 0x00, 0x00, 0x00 ,   // sp  32
     0x00, 0x00, 0x2f, 0x00, 0x00 ,   // !   33
     0x00, 0x07, 0x00, 0x07, 0x00 ,   // "   34
     0x14, 0x7f, 0x14, 0x7f, 0x14 ,   // #   35
     0x24, 0x2a, 0x7f, 0x2a, 0x12 ,   // $   36
     0xc4, 0xc8, 0x10, 0x26, 0x46 ,   // %   37
     0x36, 0x49, 0x55, 0x22, 0x50 ,   // &   38
     0x00, 0x05, 0x03, 0x00, 0x00 ,   // '   39
     0x00, 0x1c, 0x22, 0x41, 0x00 ,   // (   40
     0x00, 0x41, 0x22, 0x1c, 0x00 ,   // )   41
     0x14, 0x08, 0x3E, 0x08, 0x14 ,   // *   42
     0x08, 0x08, 0x3E, 0x08, 0x08 ,   // +   43
     0x00, 0x00, 0x50, 0x30, 0x00 ,   // ,   44
     0x10, 0x10, 0x10, 0x10, 0x10 ,   // -   45
     0x00, 0x60, 0x60, 0x00, 0x00 ,   // .   46
     0x20, 0x10, 0x08, 0x04, 0x02 ,   // /   47
     0x3E, 0x51, 0x49, 0x45, 0x3E ,   // 0   48
     0x00, 0x42, 0x7F, 0x40, 0x00 ,   // 1   49
     0x42, 0x61, 0x51, 0x49, 0x46 ,   // 2   50
     0x21, 0x41, 0x45, 0x4B, 0x31 ,   // 3   51
     0x18, 0x14, 0x12, 0x7F, 0x10 ,   // 4   52
     0x27, 0x45, 0x45, 0x45, 0x39 ,   // 5   53
     0x3C, 0x4A, 0x49, 0x49, 0x30 ,   // 6   54
     0x01, 0x71, 0x09, 0x05, 0x03 ,   // 7   55
     0x36, 0x49, 0x49, 0x49, 0x36 ,   // 8   56
     0x06, 0x49, 0x49, 0x29, 0x1E ,   // 9   57
     0x00, 0x36, 0x36, 0x00, 0x00 ,   // :   58
     0x00, 0x56, 0x36, 0x00, 0x00 ,   // ;   59
     0x08, 0x14, 0x22, 0x41, 0x00 ,   // <   60
     0x14, 0x14, 0x14, 0x14, 0x14 ,   // =   61
     0x00, 0x41, 0x22, 0x14, 0x08 ,   // >   62
     0x02, 0x01, 0x51, 0x09, 0x06 ,   // ?   63
     0x32, 0x49, 0x59, 0x51, 0x3E ,   // @   64
     0x7E, 0x11, 0x11, 0x11, 0x7E ,   // A   65
     0x7F, 0x49, 0x49, 0x49, 0x36 ,   // B   66
     0x3E, 0x41, 0x41, 0x41, 0x22 ,   // C   67
     0x7F, 0x41, 0x41, 0x22, 0x1C ,   // D   68
     0x7F, 0x49, 0x49, 0x49, 0x41 ,   // E   69
     0x7F, 0x09, 0x09, 0x09, 0x01 ,   // F   70
     0x3E, 0x41, 0x49, 0x49, 0x7A ,   // G   71
     0x7F, 0x08, 0x08, 0x08, 0x7F ,   // H   72
     0x00, 0x41, 0x7F, 0x41, 0x00 ,   // I   73
     0x20, 0x40, 0x41, 0x3F, 0x01 ,   // J   74
     0x7F, 0x08, 0x14, 0x22, 0x41 ,   // K   75
     0x7F, 0x40, 0x40, 0x40, 0x40 ,   // L   76
     0x7F, 0x02, 0x0C, 0x02, 0x7F ,   // M   77
     0x7F, 0x04, 0x08, 0x10, 0x7F ,   // N   78
     0x3E, 0x41, 0x41, 0x41, 0x3E ,   // O   79
     0x7F, 0x09, 0x09, 0x09, 0x06 ,   // P   80
     0x3E, 0x41, 0x51, 0x21, 0x5E ,   // Q   81
     0x7F, 0x09, 0x19, 0x29, 0x46 ,   // R   82
     0x46, 0x49, 0x49, 0x49, 0x31 ,   // S   83
     0x01, 0x01, 0x7F, 0x01, 0x01 ,   // T   84
     0x3F, 0x40, 0x40, 0x40, 0x3F ,   // U   85
     0x1F, 0x20, 0x40, 0x20, 0x1F ,   // V   86
     0x3F, 0x40, 0x38, 0x40, 0x3F ,   // W   87
     0x63, 0x14, 0x08, 0x14, 0x63 ,   // X   88
     0x07, 0x08, 0x70, 0x08, 0x07 ,   // Y   89
     0x61, 0x51, 0x49, 0x45, 0x43 ,   // Z   90
     0x00, 0x7F, 0x41, 0x41, 0x00 ,   // [   91
     0x55, 0x2A, 0x55, 0x2A, 0x55 ,   // 55  92
     0x00, 0x41, 0x41, 0x7F, 0x00 ,   // ]   93
     0x04, 0x02, 0x01, 0x02, 0x04 ,   // ^   94
     0x40, 0x40, 0x40, 0x40, 0x40 ,   // _   95
     0x00, 0x01, 0x02, 0x04, 0x00 ,   // '   96
     0x20, 0x54, 0x54, 0x54, 0x78 ,   // a   97
     0x7F, 0x48, 0x44, 0x44, 0x38 ,   // b   98
     0x38, 0x44, 0x44, 0x44, 0x20 ,   // c   99
     0x38, 0x44, 0x44, 0x48, 0x7F ,   // d   100
     0x38, 0x54, 0x54, 0x54, 0x18 ,   // e   101
     0x08, 0x7E, 0x09, 0x01, 0x02 ,   // f   102
     0x0C, 0x52, 0x52, 0x52, 0x3E ,   // g   103
     0x7F, 0x08, 0x04, 0x04, 0x78 ,   // h   104
     0x00, 0x44, 0x7D, 0x40, 0x00 ,   // i   105
     0x20, 0x40, 0x44, 0x3D, 0x00 ,   // j   106
     0x7F, 0x10, 0x28, 0x44, 0x00 ,   // k   107
     0x00, 0x41, 0x7F, 0x40, 0x00 ,   // l   108
     0x7C, 0x04, 0x18, 0x04, 0x78 ,   // m   109
     0x7C, 0x08, 0x04, 0x04, 0x78 ,   // n   110
     0x38, 0x44, 0x44, 0x44, 0x38 ,   // o   111
     0x7C, 0x14, 0x14, 0x14, 0x08 ,   // p   112
     0x08, 0x14, 0x14, 0x18, 0x7C ,   // q   113
     0x7C, 0x08, 0x04, 0x04, 0x08 ,   // r   114
     0x48, 0x54, 0x54, 0x54, 0x20 ,   // s   115
     0x04, 0x3F, 0x44, 0x40, 0x20 ,   // t   116
     0x3C, 0x40, 0x40, 0x20, 0x7C ,   // u   117
     0x1C, 0x20, 0x40, 0x20, 0x1C ,   // v   118
     0x3C, 0x40, 0x30, 0x40, 0x3C ,   // w   119
     0x44, 0x28, 0x10, 0x28, 0x44 ,   // x   120
     0x0C, 0x50, 0x50, 0x50, 0x3C ,   // y   121
     0x44, 0x64, 0x54, 0x4C, 0x44 ,   // z   122
    //
     0x00, 0x08, 0x36, 0x41, 0x00 ,   //7B- {
     0x00, 0x00, 0x7f, 0x00, 0x00 ,   //7C- |
     0x00, 0x41, 0x36, 0x08, 0x00 ,   //7D- }
     0x04, 0x02, 0x04, 0x08, 0x04 ,   //7E- ~
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //7F- 
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //80- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //81- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //82- В
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //83- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //84- Д
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //85- Е
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //86- Ж
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //87- З
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //88- А
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //89- Й
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //8A- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //8B- Л
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //8C- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //8D- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //8E- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //8F- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //90- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //91- С
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //92- Т
     0x00, 0x00, 0x00, 0x00, 0x00 ,   // 93- У
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //94- Ф
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //95- Х
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //96- Ц
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //97- Ч
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //98- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //99- Щ 
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //9A- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //9B- Ы
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //9C- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //9D- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //9E- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //9F- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //A0- †
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //A1- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //A2- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //A3- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //A4- §
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //A5- ?
     0x00, 0x00, 0x36, 0x00, 0x00 ,   //A6- ¶
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //A7- І
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //A8- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //A9- ©
     0x3E, 0x49, 0x49, 0x49, 0x22 ,   //AA- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //AB- Ђ
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //AC- ђ
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //AD- ≠
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //AE- Ѓ
     0x44, 0x45, 0x7C, 0x45, 0x44 ,   //AF- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //B0- ∞
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //B1- ±
     0x00, 0x41, 0x7F, 0x41, 0x00 ,   //B2- ?
     0x00, 0x44, 0x7D, 0x40, 0x00 ,   //B3- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //B4- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //B5- µ
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //B6- ґ
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //B7- Ј
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //B8- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //B9- ?
     0x38, 0x54, 0x44, 0x28, 0x00 ,   //BA- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //BB- ї
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //BC- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //BD- ?
     0x00, 0x00, 0x00, 0x00, 0x00 ,   //BE- ?
     0x4A, 0x48, 0x7A, 0x40, 0x40 ,   //BF- ?                             
    //???????
 0x7E, 0x11, 0x11, 0x11, 0x7E , // A        /*192*/
 0x7F, 0x49, 0x49, 0x49, 0x31 , // ?
 0x7F, 0x49, 0x49, 0x49, 0x36 , // B
 0x7F, 0x01, 0x01, 0x01, 0x03 , // ?
 0x60, 0x3E, 0x21, 0x21, 0x7F , // ?
 0x7F, 0x49, 0x49, 0x49, 0x41 , // E
 0x63, 0x14, 0x7F, 0x14, 0x63 , // ?
 0x22, 0x49, 0x49, 0x49, 0x36 , // ?
 0x7F, 0x10, 0x08, 0x04, 0x7F , // ?
 0x7F, 0x10, 0x09, 0x04, 0x7F , // ?
 0x7F, 0x08, 0x14, 0x22, 0x41 , // K
 0x7C, 0x02, 0x01, 0x01, 0x7F , // ?
 0x7F, 0x02, 0x0C, 0x02, 0x7F , // M
 0x7F, 0x08, 0x08, 0x08, 0x7F , // H
 0x3E, 0x41, 0x41, 0x41, 0x3E , // O
 0x7F, 0x01, 0x01, 0x01, 0x7F , // ?
 0x7F, 0x09, 0x09, 0x09, 0x06 , // P
 0x3E, 0x41, 0x41, 0x41, 0x22 , // C
 0x01, 0x01, 0x7F, 0x01, 0x01 , // T
 0x07, 0x48, 0x48, 0x48, 0x3F , // ?
 0x1C, 0x22, 0x7F, 0x22, 0x1C , // ?
 0x63, 0x14, 0x08, 0x14, 0x63 , // X
 0x3F, 0x20, 0x20, 0x3F, 0x60 , // ?
 0x07, 0x08, 0x08, 0x08, 0x7F , // ?
 0x7F, 0x40, 0x7F, 0x40, 0x7F , // ?
 0x3F, 0x20, 0x3F, 0x20, 0x7F , // ?
 0x01, 0x7F, 0x48, 0x48, 0x30 , // ?
 0x7F, 0x48, 0x48, 0x30, 0x7F , // ?
 0x7F, 0x48, 0x48, 0x48, 0x30 , // ?
 0x22, 0x49, 0x49, 0x49, 0x3E , // ?
 0x7F, 0x08, 0x3E, 0x41, 0x3E , // ?
 0x46, 0x29, 0x19, 0x09, 0x7F , // ?
 0x20, 0x54, 0x54, 0x54, 0x78 , // a
 0x78, 0x54, 0x54, 0x54, 0x20 , // b
 0x7C, 0x54, 0x54, 0x54, 0x28 , // ?
 0x7C, 0x04, 0x04, 0x04, 0x00 , // ?
 0x60, 0x38, 0x24, 0x38, 0x60 , // ?
 0x38, 0x54, 0x54, 0x54, 0x18 , // e
 0x6C, 0x10, 0x7C, 0x10, 0x6C , // ?
 0x28, 0x44, 0x54, 0x54, 0x28 , // ?
 0x3C, 0x40, 0x40, 0x20, 0x7C , // ?
 0x3C, 0x40, 0x42, 0x20, 0x7C , // ?
 0x7C, 0x10, 0x10, 0x28, 0x44 , // ?
 0x60, 0x10, 0x08, 0x04, 0x7C , // ?
 0x7C, 0x08, 0x10, 0x08, 0x7C , // ?
 0x7C, 0x10, 0x10, 0x10, 0x7C , // ?
 0x38, 0x44, 0x44, 0x44, 0x38 , // o
 0x7C, 0x04, 0x04, 0x04, 0x7C , // ?
 0x7C, 0x14, 0x14, 0x14, 0x08 , // p
 0x38, 0x44, 0x44, 0x44, 0x20 , // c
 0x04, 0x04, 0x7C, 0x04, 0x04 , // ?
 0x0C, 0x50, 0x50, 0x50, 0x3C , // y
 0x18, 0x24, 0x7C, 0x24, 0x18 , // ?
 0x44, 0x28, 0x10, 0x28, 0x44 , // x
 0x3C, 0x20, 0x20, 0x3C, 0x60 , // ?
 0x0C, 0x10, 0x10, 0x10, 0x7C , // ?
 0x7C, 0x40, 0x7C, 0x40, 0x7C , // ?
 0x3C, 0x20, 0x3C, 0x20, 0x7C , // ?
 0x04, 0x7C, 0x48, 0x48, 0x30 , // ?
 0x7C, 0x48, 0x30, 0x00, 0x7C , // ?
 0x7C, 0x48, 0x48, 0x48, 0x30 , // ?
 0x28, 0x44, 0x54, 0x54, 0x38 , // ?
 0x7C, 0x10, 0x38, 0x44, 0x38 , // ?
 0x58, 0x24, 0x24, 0x24, 0x7C  //  ?
 };
void I2C_write(unsigned char byte_send)									{//WRITE
	 while(!(I2C->SR1 & I2C_SR1_TXE)){}; 
	 I2C->DR = byte_send;
	}
void I2C_Start(void)    																{//Start
	 while(I2C->SR3 & I2C_SR3_BUSY){}; //I2C_BUSY
	 I2C->CR2 |= I2C_CR2_START;
	 while(!(I2C->SR1 & I2C_SR1_SB)){}; // Start - Generated
	 I2C->DR = T191_Addr;
	 while(!(I2C->SR1 & I2C_SR1_ADDR)){}; // ACK - Received
	 while(!(I2C->SR3 & I2C_SR3_MSL)){}; // Master mode
	 
}
void I2C_Stop(void) 																		{//Stop
	 while(!(I2C->SR1 & I2C_SR1_TXE)){}; // TX buf Empty
	 while(!(I2C->SR1 & I2C_SR1_BTF)){}; // TX buf Empty
	  I2C->CR2 |= I2C_CR2_STOP;
	 while(I2C->SR3 & I2C_SR3_BUSY){};
 }
void LCD_Init(void) 																		{// INIT LCD T191
    
		 RES_LO();delay_ms(10);
  	 RES_HI();delay_ms(10);

     I2C_Start();
     I2C_write(0x00);I2C_write(0x31);
     I2C_write(0x14);I2C_write(0x06); 																			// Initial Settings
     I2C_write(0x30);I2C_write(0x11);
     I2C_write(0x05);I2C_write(0x31);
     I2C_write(0x9A); 																											// Contrast
     I2C_write(0x0C); 																											//0x0C -Normal mode, 00 - Mirror mode
     I2C_write(0x30);I2C_write(0x0C); 																			// ?????????? ?????
     I2C_write(0x40);I2C_write(0x80); 																			// GoTo x=0, y=0
     I2C_Stop();
    }

void LCD_Gotoxy ( uint8_t x, uint8_t y )								{//78.00.30.80|x.40|y    x- 0..15, y- 0..7 
       I2C_Start();
       I2C_write(0x00);
       I2C_write(0x30);
       I2C_write(0x80 | 1+x*6);  																//(0...15 Colls
       I2C_write(0x40 | y);  																		//(0...7 - Rows)
       I2C_Stop();
    }
void LCD_Write_data (unsigned char dat_byte)						{//78.40.XX
       I2C_Start();
       I2C_write(0x40);
       I2C_write(dat_byte);
       I2C_Stop();
      }
void LCD_mode(uint8_t mode)															{//78.00.30.0C - Normal; 78.00.30.0D - Inverse 
      
       I2C_Start();
       if(mode > 0)
       {I2C_write(0x00);I2C_write(0x30);I2C_write(0x0C);}
       else
       {I2C_write(0x00);I2C_write(0x30);I2C_write(0x0D);}
       I2C_Stop();
      }
void LCD_Char(char flash_o, uint8_t mode)								{// Print Symbol
      	 unsigned char i,ch; 
         I2C_Start();
         I2C_write(0x40);
          for(i=0; i<5; i++)
      	  {
      	    ch = T191_font[(flash_o - 32)*5+i];
      	     if(mode) { I2C_write(~ch); }
      			 else  	 { I2C_write(ch);}
      		 if(i == 4)
      			  {
      			     if(mode) { I2C_write(0xff); }
      				  else   {	 I2C_write(0x00); }
      			  }
      	   }
         I2C_Stop();
          }
void LCD_PrintStr(char *s, uint8_t mode)								{// Print String
          while (*s)
        {
          LCD_Char(*s, mode);
          s++;
        }
      }
void LCD_Clear(void)      															{// Clear LCD
    	 unsigned char i;
			 
			 	for(i = 0; i < 9; i++) LCD_PrintStr("                ",0);
      }
void LCD_ClearStr(uint8_t y,uint8_t qn)      						{// Clear String
 uint8_t temp_i; 	 
	for (temp_i=0;temp_i<qn;temp_i++)
	 {
		 LCD_Gotoxy(0,y+temp_i);    	
		 LCD_PrintStr("                ",0);
   }
}
void LCD_PrintDec(long value,uint8_t mode) 							{// Print Dec
	
	char i=1,d=0;
	unsigned char text[10];
	do 
  { 
    if (value >=10)  {
				d = value % 10; 																				// ??????? ?? ???????
				text[i] = d + '0'; 																			// ????? ASCII ?????? ? ???????? ? ?????
				value /= 10; 																						// "?????????? ????? ??????" -- ??????? ?? 10
			}
		else 
			{	text[i] = value + '0';
				value=0;
			}
 		i++;
  }
	while(value); 
	i--;			
	do
	{	LCD_Char(text[i], mode);
		i--;
	}
	while(i);
}
void LCD_PrintHex(long value,uint8_t mode) 							{// Print Hex
	
	char i=1,d=0;
	unsigned char text[10];
	do 
  { 
    if (value >=0x10)  {
				d = value % 0x10; 																				
				if(d<0x0A) text[i] = d + '0'; 																			
				else 			 text[i] = d + 0x37;
				value /= 0x10; 																						
			}
		else 
			{	
				if(value < 0x0A)	text[i] = value + '0';			//0..9
				else 							text[i] = value + 0x37;			//A...F
				value=0;
			}
 		i++;
  }
	while(value); 
	i--;			
	do
	{	LCD_Char(text[i], mode);
		i--;
	}
	while(i);
}
void LCD_PrintBin(uint8_t value,uint8_t mode) 					{// Print Bin
	
	uint8_t i=1,d=0;
	uint8_t text[8];
	do 
  { 
    if (value >=2)  {
				d = value % 2; 																				
				text[i] = d + '0'; 																			
				value /= 0x2; 																						
			}
		else 
			{	
				text[i] = value + '0';			//0..9
				value=0;
			}
 		i++;
  }
	while(i<9); 
	i--;			
	do
	{	LCD_Char(text[i], mode);
		i--;
	}
	while(i);
}



const unsigned char  dig1216[]  = 											{//digits big font

 0,0,248,254,6,131,195,99,51,30,254,248,0,0,7,31,27,49,48,48,48,24,31,7,      // 0
 0,0,0,12,12,14,255,255,0,0,0,0,0,0,0,48,48,48,63,63,48,48,48,0,              // 1
 0,0,28,30,7,3,131,195,227,119,62,28,0,0,56,60,62,55,51,49,48,48,48,48,       // 2
 0,0,12,14,7,195,195,195,195,231,126,60,0,0,12,28,56,48,48,48,48,57,31,14,    // 3
 0,0,192,224,112,56,28,14,255,255,0,0,0,0,7,7,6,6,6,6,63,63,6,6,              // 4
 0,0,120,127,103,99,99,99,99,227,195,131,0,0,12,28,56,48,48,48,48,56,31,15,   // 5
 0,0,192,240,248,220,206,199,195,195,128,0,0,0,15,31,57,48,48,48,48,57,31,15, // 6
 0,0,3,3,3,3,3,195,243,63,15,3,0,0,0,0,48,60,15,3,0,0,0,0,                    // 7
 0,0,0,188,254,231,195,195,231,254,188,0,0,0,15,31,57,48,48,48,48,57,31,15,   // 8
 0,0,60,126,231,195,195,195,195,231,254,252,0,0,0,48,48,48,56,28,14,7,3,0,    // 9
 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,56,56,56,0,0,0,0														// .
	
	};
void LCD_PrintBig(long value, char xx,char yy) 							{// Print Dec
	
    char i, d, dp,j;
    unsigned char text[10];
				
		dp =3; // decimal point position
    i= 5;
		
		do 
		  {
       if (i == dp) text[i] = 10; // place decimal point
       else 
          {
            if (value == 0)
             {
              if (i >= dp - 1)  
							   text[i] = 0; // place zero
              else    
 							   text[i] = 0; // place leading space
             }
            else
             {
              d = value % 10; // least significant digit
              text[i] = d; // make ASCII char and put into text
              value /= 10; // "decimal right shift" -- divide by ten
             }
          }
	   	  i--;
		  }
			while(i); 

//--------------------------------------------------------------------
	i=1;d=1;
	
	  	 I2C_Start();I2C_write(0x00);I2C_write(0x30);
			 I2C_write(0x80 | 1+xx*13);  																//(0...15 Colls
       I2C_write(0x40 | yy);  																		//(0...7 - Rows)
       I2C_Stop();
	do
	{
		 I2C_Start();
     I2C_write(0x40);
     for(j=0; j<12; j++)
     {
       I2C_write(dig1216[(text[i])*24+j]);
		 }
		 I2C_Stop();
		i++;
	}
	while(i<6);
	
			 I2C_Start();I2C_write(0x00);I2C_write(0x30);
       I2C_write(0x80 | 1+xx*13);																//(0...8 Colls
       I2C_write(0x40 | yy +1); 															//(0...4 - Rows)
       I2C_Stop();
	
	do
	{
		 I2C_Start();
     I2C_write(0x40);
     for(j=12; j<24; j++)
     {
       I2C_write(dig1216[(text[d])*24+j]);
		 }
		 I2C_Stop();
		d++;
	}
	while(d<6);
	
}

void wait_mode (void) {			// Waiting when transmited
	
	RES_LO();delay_ms(10);
	RES_HI();delay_ms(10);
	I2C->CR1 &=~I2C_CR1_PE;
	TIM2->CR1 &=~TIM_CR1_CEN;
	TIM4->CR1 &=~TIM4_CR1_CEN;
	CLK->PCKENR &=~(CLK_PCKENR_I2C | CLK_PCKENR_TIM4 | CLK_PCKENR_TIM2);
	GPIO_PULL_UP();
	_asm("sim");		
			EXTI->CR1 |=	0b10; 	 // PB0 - 01-Rising, 10 - Falling Edge, 11 - Both
			EXTI->CR1 |=	0b10<<1; // PB1 - 01-Rising, 10 - Falling Edge, 11 - Both
			EXTI->CR1 |=	0b10<<2; // PB2 - 01-Rising, 10 - Falling Edge, 11 - Both
	_asm("rim");
	ENC_INT();		
		_asm("halt");  //уснуть
	ENC();LCD_PORT();
	CLK->PCKENR |=CLK_PCKENR_I2C | CLK_PCKENR_TIM4 | CLK_PCKENR_TIM2;
	TIM4->CR1 |=TIM4_CR1_CEN;
	TIM2->CR1 |=TIM_CR1_CEN;
	I2C->CR1 |=I2C_CR1_PE;
	LCD_Init();
}

//------------------------------------------Start-----------
int main(void) {
initial();
init_encoder();
i2c_init();
LCD_Init(); 
LCD_Clear();   
LCD_Gotoxy(3,0);LCD_PrintStr(" —четчик ",1); 
imp_per_metr=100;	
//----------------Main Cycle
while (1)		 {


if(!BUTTON()){
	LCD_Gotoxy(15,7);LCD_PrintDec(button_sec,0);
	LCD_Gotoxy(7,7);
		switch (button_sec) {
			case 1:	{TIM2->CNTRH=0;TIM2->CNTRL=0;Counter=0;	LCD_PrintStr(" Reset ",1);}break;
			case 2: {count_dir=0;														LCD_PrintStr("  Up   ",1);}break;
			case 3: {count_dir=1;														LCD_PrintStr("  Down ",1);}break;
			case 4: {imp_per_metr=100;											LCD_PrintStr("  Imp  ",1);}break;
			case 5: {button_sec=0;													LCD_PrintStr("  Ret  ",1);}break;
			default: {} break;
		}
}
else {
LCD_ClearStr(7,1);
}

temp_count= (Counter*(1000/imp_per_metr))/10;

LCD_PrintBig(temp_count,1,3);LCD_Gotoxy(13,4);LCD_PrintStr("—ћ ",0);
LCD_Gotoxy(1,5);LCD_PrintStr("Cчет: ",0) ;LCD_PrintDec(Counter,0);LCD_PrintStr("    ",0);
LCD_Gotoxy(1,6);LCD_PrintStr("1 метр= ",0);LCD_PrintDec(imp_per_metr,0); LCD_PrintStr("имп.    ",0);

if(go_sleep) wait_mode();

if(!MENU()) {imp_per_metr=Counter;}

} // END while
} // End Main

#ifdef  USE_FULL_ASSERT

/**
  * @brief  Reports the name of the source file and the source line number
  *   where the assert_param error has occurred.
  * @param file: pointer to the source file name
  * @param line: assert_param error line source number
  * @retval : None
  */
void assert_failed(uint8_t* file, uint32_t line)
{
    /* User can add his own implementation to report the file name and line number,
       ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */

    /* Infinite loop */
    while (1)
    {
    }
}
#endif
